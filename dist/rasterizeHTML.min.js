/*! rasterizeHTML.js - v0.1.0 - 2012-11-17
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2012 Christoph Burgmer; Licensed MIT */
var rasterizeHTML=function(e,t,n){"use strict";var r={},i=[];r.util={},r.util.getConstantUniqueIdFor=function(e){return i.indexOf(e)<0&&i.push(e),i.indexOf(e)},r.util.cloneArray=function(e){return Array.prototype.slice.apply(e,[0])},r.util.log=function(t){e.console&&e.console.log&&e.console.log(t)},r.util.joinUrl=function(e,n){var r=new t(n);return r.is("relative")&&(r=r.absoluteTo(e)),r.toString()},r.util.isDataUri=function(e){return/^data:/.test(e)},r.util.map=function(e,t,n){var i=0,s=r.util.cloneArray(e),o=[],u;s.length===0&&n(o);var a=function(e){function r(t){i+=1,o[e]=t,i===s.length&&n(o)}t(s[e],r)};for(u=0;u<s.length;u++)a(u)};var s=function(e){return e+"?_="+Date.now()};r.util.ajax=function(t,n,r,i){var o=new e.XMLHttpRequest,u;n=n||{},u=n.cache===!1?s(t):t,o.addEventListener("load",function(){o.status===200||o.status===0?r(o.response):i()},!1),o.addEventListener("error",function(){i()},!1),o.open("GET",u,!0),o.overrideMimeType(n.mimeType);try{o.send(null)}catch(a){i()}},r.util.binaryAjax=function(e,t,n,i){var s="";t=t||{},r.util.ajax(e,{mimeType:"text/plain; charset=x-user-defined",cache:t.cache},function(e){for(var t=0;t<e.length;t++)s+=String.fromCharCode(e.charCodeAt(t)&255);n(s)},i)};var o=function(e){var t=/^"(.*)"$/,n=/^'(.*)'$/;return t.test(e)?e.replace(t,"$1"):n.test(e)?e.replace(n,"$1"):e},u=function(e){var t=/^[\t\r\f\n ]*(.+?)[\t\r\f\n ]*$/;return e.replace(t,"$1")};r.util.extractCssUrl=function(e){var t=/^url\(([^\)]+)\)/,n;if(!t.test(e))throw new Error("Invalid url");return n=t.exec(e)[1],o(u(n))};var a=function(t){var n=e.document.createElement("canvas"),r=n.getContext("2d");return n.width=t.width,n.height=t.height,r.drawImage(t,0,0),n.toDataURL("image/png")};r.util.getDataURIForImageURL=function(t,n,r,i){var o=new e.Image,u,f;n=n||{},f=n.cache===!1?s(t):t,o.onload=function(){try{u=a(o)}catch(e){i();return}r(u)},i&&(o.onerror=i),o.src=f};var f=function(e,t){return t&&t!=="about:blank"&&(e=r.util.joinUrl(t,e)),e},l=function(e){return Array.prototype.slice.call(e)},c=function(e){var t=document.implementation.createHTMLDocument(""),n=document.createElement("style");return n.textContent=e,t.body.appendChild(n),l(n.sheet.cssRules)},h=function(e){var t="";return e.forEach(function(e){t+=e.cssText}),t},p=function(e){var t=new n,r=t.parse(e,!1,!0);return r},d=function(t){var n=[],r,i,s;if(!t)return[];for(r=0;r<t.cssRules.length;r++){s=t.cssRules[r];if(s.type===e.kJscsspSTYLE_RULE)for(i=0;i<s.declarations.length;i++)s.declarations[i].property==="background-image"&&n.push(s.declarations[i])}return n},v=function(t){var n=[];return t.forEach(function(t){t.type===e.CSSRule.STYLE_RULE&&t.style.backgroundImage&&n.push(t)}),n},m=function(t){var n=[],r,i,s;if(!t)return[];for(r=0;r<t.cssRules.length;r++){s=t.cssRules[r];if(s.type===e.kJscsspFONT_FACE_RULE)for(i=0;i<s.descriptors.length;i++)s.descriptors[i].property==="src"&&n.push(s.descriptors[i])}return n},g=function(t){var n=[];return t.forEach(function(t){t.type===e.CSSRule.FONT_FACE_RULE&&t.style.getPropertyValue("src")&&n.push(t)}),n},y=function(e){var t={},n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},b=function(e){return typeof e=="object"&&e!==null},w=function(e){return b(e)&&Object.prototype.toString.apply(e).match(/\[object (Canvas|HTMLCanvasElement)\]/i)},E=function(e){return typeof e=="function"};r.util.parseOptionalParameters=function(){var e={canvas:null,options:{},callback:null};return E(arguments[0])?e.callback=arguments[0]:arguments[0]==null||w(arguments[0])?(e.canvas=arguments[0],E(arguments[1])?e.callback=arguments[1]:(e.options=y(arguments[1]),e.callback=arguments[2]||null)):(e.options=y(arguments[0]),e.callback=arguments[1]||null),e};var S=function(e,t,n,i,s){var o=e.attributes.src.nodeValue,u=t||e.ownerDocument.baseURI;r.util.isDataUri(o)&&i(),o=f(o,u),r.util.getDataURIForImageURL(o,{cache:n},function(t){e.attributes.src.nodeValue=t,i()},function(){s(o)})},x=function(e){var t=[];return Array.prototype.forEach.call(e,function(e){e.type==="image"&&t.push(e)}),t};r.loadAndInlineImages=function(e,t,n){var i=r.util.parseOptionalParameters(t,n),s=e.getElementsByTagName("img"),o=e.getElementsByTagName("input"),u=i.options.baseUrl,a=i.options.cache!==!1,f=[],l=[];f=Array.prototype.slice.call(s),f=f.concat(x(o)),r.util.map(f,function(e,t){S(e,u,a,t,function(e){l.push({resourceType:"image",url:e}),t()})},function(){i.callback&&i.callback(l)})};var T=function(e,t){var n;try{n=r.util.extractCssUrl(t)}catch(i){return t}return r.util.isDataUri(n)?t:(n=r.util.joinUrl(e,n),'url("'+n+'")')},N=function(e,t){var n=v(t),r=!1;return n.forEach(function(t){var n=t.style.backgroundImage,i=T(e,n);i!==n&&(r=!0,t.style.backgroundImage=i)}),r},C=function(e,t,n){var r=e.indexOf(t),i="@font-face { font-family: "+t.style.getPropertyValue("font-family")+"; src: "+n+"}",s=t.parentStyleSheet;s.insertRule(i,r+1),s.deleteRule(r),e[r]=s.cssRules[r]},k=function(e,t){var n=g(t),r=!1;return n.forEach(function(n){var i=n.style.getPropertyValue("src"),s=T(e,i);s!==i&&(r=!0,C(t,n,s))}),r},L=function(e,t){var n=c(t),r=!1;return r=N(e,n)||r,r=k(e,n)||r,r?h(n):t},A=function(e,t){var n=e.parentNode,r;t=t.trim(),t&&(r=e.ownerDocument.createElement("style"),r.type="text/css",r.appendChild(e.ownerDocument.createTextNode(t)),n.insertBefore(r,e)),n.removeChild(e)},O=function(e,t,n,i,s){var o=e.attributes.href.nodeValue,u=t||e.ownerDocument.baseURI,a=f(o,u),l;r.util.ajax(a,{cache:n},function(e){l=L(o,e),i(l)},function(){s(a)})};r.loadAndInlineCSS=function(e,t,n){var i=r.util.parseOptionalParameters(t,n),s=e.getElementsByTagName("link"),o=i.options.baseUrl,u=i.options.cache!==!1,a=[];r.util.map(s,function(e,t){e.attributes.rel&&e.attributes.rel.nodeValue==="stylesheet"&&(!e.attributes.type||e.attributes.type.nodeValue==="text/css")?O(e,o,u,function(n){A(e,n+"\n"),t()},function(e){a.push({resourceType:"stylesheet",url:e}),t()}):t()},function(){i.callback&&i.callback(a)})};var M=function(t){var n=[],r,i;for(r=0;r<t.cssRules.length;r++)i=t.cssRules[r],i.type===e.kJscsspIMPORT_RULE&&n.push(i);return n},_=function(e){return{cssText:function(){return e}}},D=function(e,t,n){var r=L(t,n),i=_(r),s=e.parentStyleSheet,o=s.cssRules.indexOf(e);s.cssRules.splice(o,1,i)},P=function(e){var t=/^"(.*)"$/,n=/^'(.*)'$/;return t.test(e)||n.test(e)},H=function(e,t,n,i,s,u){var a=e.href,l,c;if(P(a))c=o(a);else try{c=r.util.extractCssUrl(a)}catch(h){s(!1);return}l=f(c,t);if(i.indexOf(l)>=0){D(e,c,""),s(!0,[]);return}i.push(l),r.util.ajax(l,{cache:n},function(r){B(r,t,n,i,function(t,n){D(e,c,t),s(!0,n)})},function(){u(l)})},B=function(e,t,n,r,i){var s=p(e),o=[],u;if(!s){i(e,o);return}u=M(s),rasterizeHTML.util.map(u,function(e,i){H(e,t,n,r,function(e,t){o=o.concat(t),i(e)},function(e){o.push({resourceType:"stylesheet",url:e}),i()})},function(t){t.indexOf(!0)>=0&&(e=s.cssText().trim()),i(e,o)})},j=function(e,t,n,r,i){B(e.textContent,t,n,r,function(t,n){e.textContent!==t&&(e.childNodes[0].nodeValue=t),i(n)})};r.loadAndInlineCSSImports=function(e,t,n){var i=r.util.parseOptionalParameters(t,n),s=e.getElementsByTagName("style"),o=i.options.baseUrl||e.baseURI,u=i.options.cache!==!1,a=[],f=[];r.util.map(s,function(e,t){e.attributes.type&&e.attributes.type.nodeValue==="text/css"?j(e,o,u,f,function(e){a=a.concat(e),t()}):t()},function(){i.callback(a)})};var F=function(e,t,n,i,s){var o;try{o=r.util.extractCssUrl(e.values[0].cssText())}catch(u){i(!1);return}if(r.util.isDataUri(o)){i(!1);return}o=f(o,t),r.util.getDataURIForImageURL(o,{cache:n},function(t){e.values[0].setCssText('url("'+t+'")'),i(!0)},function(){s(o)})},I=function(e,t,n,r){var i=d(e),s=[],o;rasterizeHTML.util.map(i,function(e,r){F(e,t,n,r,function(e){s.push({resourceType:"backgroundImage",url:e}),r()})},function(e){o=e.indexOf(!0)>=0,r(o,s)})},q=function(e,t,n,i,s){var o,u;try{o=r.util.extractCssUrl(e.values[0].cssText())}catch(a){i(!1);return}if(r.util.isDataUri(o)){i(!1);return}o=f(o,t),r.util.binaryAjax(o,{cache:n},function(t){u=btoa(t),e.values[0].setCssText('url("data:font/woff;base64,'+u+'")'),i(!0)},function(){s(o)})},R=function(e,t,n,r){var i=m(e),s=[],o;rasterizeHTML.util.map(i,function(e,r){q(e,t,n,r,function(e){s.push({resourceType:"fontFace",url:e}),r()})},function(e){o=e.indexOf(!0)>=0,r(o,s)})},U=function(t,n){var r=d(n).length+m(n).length>0;return r&&e.navigator.userAgent.indexOf("WebKit")>=0?"span {}\n"+t:t},z=function(e,t,n,r){var i=e.textContent,s=t||e.ownerDocument.baseURI,o=p(i);I(o,s,n,function(t,u){R(o,s,n,function(n,s){if(t||n)i=o.cssText();i=U(i,o),e.childNodes[0].nodeValue=i,r(u.concat(s))})})};r.loadAndInlineCSSReferences=function(e,t,n){var i=r.util.parseOptionalParameters(t,n),s=[],o=i.options.baseUrl,u=i.options.cache!==!1,a=e.getElementsByTagName("style");r.util.map(a,function(e,t){e.attributes.type&&e.attributes.type.nodeValue==="text/css"?z(e,o,u,function(e){s=s.concat(e),t()}):t()},function(){i.callback&&i.callback(s)})};var W=function(){return e.navigator.userAgent.indexOf("WebKit")>=0},X=function(t){var n;return t.documentElement.setAttribute("xmlns",t.documentElement.namespaceURI),n=(new e.XMLSerializer).serializeToString(t.documentElement),W()?e.HTMLtoXML?e.HTMLtoXML(n):(r.util.log("Looks like your browser needs htmlparser.js as workaround for writing XML. Please include it."),n):n},V=function(){if(e.navigator.userAgent.indexOf("WebKit")>=0&&e.navigator.userAgent.indexOf("Chrome")<0)return!1;if(e.BlobBuilder||e.MozBlobBuilder||e.WebKitBlobBuilder)return!0;if(e.Blob)try{return new e.Blob("<b></b>",{type:"text/xml"}),!0}catch(t){return!1}return!1},$=function(t){var n="image/svg+xml;charset=utf-8",r=e.BlobBuilder||e.MozBlobBuilder||e.WebKitBlobBuilder,i;return r?(i=new r,i.append(t),i.getBlob(n)):new e.Blob(t,{type:n})},J=function(t){var n=e.URL||e.webkitURL||e;return V()?n.createObjectURL($(t)):"data:image/svg+xml;charset=utf-8,"+t},K=function(t){var n=e.URL||e.webkitURL||e;V()&&n.revokeObjectURL(t)},Q=function(e,t){var n=e.getElementById(t);return n||(n=e.createElement("div"),n.style.visibility="hidden",n.style.width="0px",n.style.height="0px",n.style.position="absolute",n.style.top="-10000px",n.style.left="-10000px",n.id=t,e.getElementsByTagName("body")[0].appendChild(n)),n},G="rasterizeHTML_js_FirefoxWorkaround",Y=function(t,n){var i=r.util.getConstantUniqueIdFor(t),s=n?n.ownerDocument:e.document,o=Q(s,G+i);o.innerHTML=t,o.className=G},Z=function(t,n){var i=r.util.getConstantUniqueIdFor(t),s=n?n.ownerDocument:e.document,o=s.getElementById(G+i);o&&o.parentNode.removeChild(o)};r.getSvgForDocument=function(e,t,n){var r=X(e);return'<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+n+'">'+'<foreignObject width="100%" height="100%">'+r+"</foreignObject>"+"</svg>"},r.renderSvg=function(t,n,r,i){var s,o,u=function(){o.onload=null,o.onerror=null},a=function(){s&&K(s),Z(t,n)};Y(t,n),s=J(t),o=new e.Image,o.onload=function(){u(),a(),r(o)},o.onerror=function(){a(),i()},o.src=s},r.drawImageOnCanvas=function(e,t){try{t.getContext("2d").drawImage(e,0,0)}catch(n){return!1}return!0};var et=function(e,t,n){var i=[];r.loadAndInlineImages(e,t,function(s){i=i.concat(s),r.loadAndInlineCSS(e,t,function(s){i=i.concat(s),r.loadAndInlineCSSImports(e,t,function(s){i=i.concat(s),r.loadAndInlineCSSReferences(e,t,function(e){i=i.concat(e),n(i)})})})})};return r.drawDocument=function(e,t,n,i){var s=r.util.parseOptionalParameters(t,n,i),o=function(e){e.push({resourceType:"document"})},u=s.canvas?s.canvas.width:300,a=s.canvas?s.canvas.height:200,f=s.options.width!==undefined?s.options.width:u,l=s.options.height!==undefined?s.options.height:a;et(e,s.options,function(t){var n=r.getSvgForDocument(e,f,l),i;r.renderSvg(n,s.canvas,function(e){s.canvas&&(i=r.drawImageOnCanvas(e,s.canvas),i||(o(t),e=null)),s.callback&&s.callback(e,t)},function(){o(t),s.callback&&s.callback(null,t)})})},r.drawHTML=function(t,n,i,s){var o=r.util.parseOptionalParameters(n,i,s),u=e.document.implementation.createHTMLDocument("");u.documentElement.innerHTML=t,r.drawDocument(u,o.canvas,o.options,o.callback)},r.drawURL=function(e,t,n,i){var s=r.util.parseOptionalParameters(t,n,i),o=s.options.cache;s.options.baseUrl=e,r.util.ajax(e,{cache:o},function(e){r.drawHTML(e,s.canvas,s.options,s.callback)},function(){s.callback&&s.callback(null,[{resourceType:"page",url:e}])})},r}(window,URI,CSSParser);